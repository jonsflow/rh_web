<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Options Risk Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .position-card {
            margin-bottom: 20px;
        }
        .order-code {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            white-space: pre-wrap;
        }
        .pnl-positive { color: #28a745; }
        .pnl-negative { color: #dc3545; }
        .pnl-neutral { color: #6c757d; }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-green { background-color: #28a745; }
        .status-red { background-color: #dc3545; }
        .status-gray { background-color: #6c757d; }
        .refresh-button {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
        .trail-stop-indicator {
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 3px;
        }
        .trail-stop-active {
            background-color: #17a2b8;
            color: white;
        }
        .trail-stop-triggered {
            background-color: #dc3545;
            color: white;
        }
        .trail-stop-submitted {
            background-color: #ffc107;
            color: #212529;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .order-state-confirmed {
            background-color: #e7f3ff;
            color: #0066cc;
        }
        .order-state-filled {
            background-color: #d4edda;
            color: #155724;
        }
        .order-state-partially_filled {
            background-color: #fff3cd;
            color: #856404;
        }
        .order-state-cancelled {
            background-color: #f8d7da;
            color: #721c24;
        }
        .order-state-rejected {
            background-color: #f8d7da;
            color: #721c24;
        }
        .order-id {
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        
        /* Trailing Stop Indicators */
        .trail-stop-indicator {
            font-size: 0.8rem;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 12px;
            margin-left: 8px;
        }
        .trail-stop-active {
            background-color: #e3f2fd;
            color: #1976d2;
        }
        .trail-stop-triggered {
            background-color: #ffebee;
            color: #c62828;
            animation: pulse 1s infinite;
        }
        .trail-stop-submitted {
            background-color: #fff3e0;
            color: #ef6c00;
        }
        
        /* Take Profit Indicators */
        .take-profit-indicator {
            font-size: 0.8rem;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 12px;
            margin-left: 8px;
        }
        .take-profit-active {
            background-color: #e8f5e8;
            color: #2e7d32;
        }
        .take-profit-triggered {
            background-color: #e8f5e8;
            color: #1b5e20;
            animation: pulse 1s infinite;
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
        }
    </style>
</head>
<body>
    <div class="container-fluid mt-4">
        <h1 class="mb-4">
            üìä Options Risk Manager
            {% if account_info %}
            <span class="badge bg-info ms-2">{{ account_info.display_name }}</span>
            {% endif %}
            <span id="marketStatus" class="badge bg-secondary ms-2">Market Closed</span>
            <span id="tradingMode" class="badge {% if live_trading_mode %}bg-danger{% else %}bg-secondary{% endif %} ms-2">{% if live_trading_mode %}üî• LIVE TRADING{% else %}üõà READ-ONLY{% endif %}</span>
        </h1>
        
        {% if account_info %}
        <div class="row mb-3">
            <div class="col">
                <div class="card border-info">
                    <div class="card-body py-2">
                        <div class="row align-items-center">
                            <div class="col-auto">
                                <a href="/" class="btn btn-outline-secondary btn-sm">
                                    <i class="bi bi-arrow-left"></i> Back to Accounts
                                </a>
                            </div>
                            <div class="col">
                                <small class="text-muted">
                                    Monitoring: <strong>{{ account_info.display_name }}</strong>
                                    - State: {{ account_info.state|title }}
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
        
        <div class="refresh-button">
            <button class="btn btn-primary me-2" onclick="loadPositions()">Refresh</button>
            <button class="btn btn-warning me-2" onclick="reloadPositions()">Reload Positions</button>
            <button class="btn btn-outline-info me-2" onclick="loadOrders()">Load Orders</button>
        </div>

        <div id="summaryCard" class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">Portfolio Summary</h5>
                <div class="row">
                    <div class="col-md-6">
                        <h4 id="totalPnL" class="pnl-neutral">$0.00</h4>
                        <small class="text-muted">Total P&L</small>
                    </div>
                    <div class="col-md-6 text-end">
                        <small class="text-muted">Last Update: <span id="lastUpdate">--:--:--</span></small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Orders Table -->
        <div id="ordersSection" class="card mb-4" style="display: none;">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    üìã Active Orders
                    <span id="orderCount" class="badge bg-secondary ms-2">0</span>
                    <span id="orderMode" class="badge bg-secondary ms-2">READ-ONLY</span>
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Order ID</th>
                                <th>Symbol</th>
                                <th>Type</th>
                                <th>Quantity</th>
                                <th>Limit Price</th>
                                <th>State</th>
                                <th>Submitted</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="ordersTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="positionsContainer">
            <!-- Positions will be loaded here -->
        </div>

        <div id="loadingIndicator" class="text-center mt-4" style="display: none;">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    </div>

    <!-- Close Confirmation Modal -->
    <div class="modal fade" id="closeModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Close Position Orders</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Quick Price Calculators -->
                    <div class="mb-3">
                        <h6>Quick Calculate:</h6>
                        
                        <!-- Stop Loss Slider -->
                        <div class="mb-3">
                            <div class="d-flex align-items-center">
                                <button type="button" class="btn btn-outline-danger btn-sm me-2" onclick="calculateStopLoss()">
                                    üõë Stop Loss (-<span id="stopLossPercentDisplay">20</span>%)
                                </button>
                                <input type="range" class="form-range flex-grow-1 mx-2" id="stopLossSlider" 
                                       min="5" max="50" value="20" step="1" 
                                       onchange="updateStopLossButton()" oninput="updateStopLossPrice()">
                                <small class="text-muted">5%-50%</small>
                            </div>
                        </div>
                        
                        <!-- Take Profit Slider -->
                        <div class="mb-3">
                            <div class="d-flex align-items-center">
                                <button type="button" class="btn btn-outline-success btn-sm me-2" onclick="calculateTakeProfit()">
                                    üí∞ Take Profit (+<span id="takeProfitPercentDisplay">50</span>%)
                                </button>
                                <input type="range" class="form-range flex-grow-1 mx-2" id="takeProfitSlider" 
                                       min="10" max="200" value="50" step="5" 
                                       onchange="updateTakeProfitButton()" oninput="updateTakeProfitPrice()">
                                <small class="text-muted">10%-200%</small>
                            </div>
                        </div>
                        
                        <!-- Reset Button -->
                        <button type="button" class="btn btn-outline-secondary btn-sm w-100" onclick="resetToDefault()">
                            ‚Ü∫ Reset to Default (Current Price - 5%)
                        </button>
                    </div>
                    
                    <p class="text-warning">‚ö†Ô∏è This will submit the following sell orders when running in live mode. In read-only mode, submission is disabled.</p>
                    <div id="closeOrdersList"></div>
                    <div class="mt-3">
                        <strong>Total Estimated Proceeds: <span id="totalProceeds">$0.00</span></strong>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button id="submitOrdersBtn" type="button" class="btn btn-danger" onclick="executeCloseOrders()">
                        ‚úÖ Submit Orders
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Trailing Stop Configuration Modal -->
    <div class="modal fade" id="trailStopModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Trailing Stop Configuration</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <h6 id="trailStopSymbol">Position: </h6>
                        <small class="text-muted">Current Price: $<span id="trailStopCurrentPrice">0.00</span></small>
                    </div>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="trailStopEnabled">
                        <label class="form-check-label" for="trailStopEnabled">
                            <strong>Enable Trailing Stop</strong>
                        </label>
                    </div>
                    
                    <div class="mb-3">
                        <label for="trailStopPercent" class="form-label">Trailing Stop Percentage:</label>
                        <input type="range" class="form-range" id="trailStopPercent" min="5" max="50" value="20" step="1">
                        <div class="d-flex justify-content-between">
                            <small>5%</small>
                            <strong><span id="trailStopPercentDisplay">20</span>%</strong>
                            <small>50%</small>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <strong>How it works:</strong><br>
                        ‚Ä¢ Trail stop will trigger if price drops <strong><span id="trailStopPercentInfo">20</span>%</strong> from the highest price seen<br>
                        ‚Ä¢ Current trigger would be: $<span id="trailStopTriggerPreview">0.00</span><br>
                        ‚Ä¢ Orders are submitted only in live mode
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-info" onclick="saveTrailStopConfig()">
                        üíæ Save Configuration
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Take Profit Configuration Modal -->
    <div class="modal fade" id="takeProfitModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Take Profit Configuration</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <h6 id="takeProfitSymbol">Position: </h6>
                        <small class="text-muted">Current P&L: <span id="takeProfitCurrentPnL">+0.0%</span></small>
                    </div>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="takeProfitEnabled">
                        <label class="form-check-label" for="takeProfitEnabled">
                            <strong>Enable Take Profit</strong>
                        </label>
                    </div>
                    
                    <div class="mb-3">
                        <label for="takeProfitPercent" class="form-label">Take Profit Percentage:</label>
                        <input type="range" class="form-range" id="takeProfitPercent" min="10" max="200" value="50" step="5">
                        <div class="d-flex justify-content-between">
                            <small>10%</small>
                            <strong><span id="takeProfitPercentDisplay">50</span>%</strong>
                            <small>200%</small>
                        </div>
                    </div>
                    
                    <div class="alert alert-success">
                        <strong>How it works:</strong><br>
                        ‚Ä¢ Take profit will trigger when P&L reaches <strong>+<span id="takeProfitPercentInfo">50</span>%</span><br>
                        ‚Ä¢ Current target: <strong>+<span id="takeProfitTargetDisplay">$0.00</span> profit</strong><br>
                        ‚Ä¢ <strong>Automatic order placement</strong> when target is reached
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" onclick="saveTakeProfitConfig()">
                        üíæ Save Configuration
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let positionsData = [];
        let selectedPositions = [];
        const accountPrefix = {% if account_prefix %}'{{ account_prefix }}'{% else %}null{% endif %};

        function loadPositions() {
            document.getElementById('loadingIndicator').style.display = 'block';
            
            fetch(accountPrefix ? `/api/account/${accountPrefix}/positions` : '/api/positions')
                .then(response => response.json())
                .then(data => {
                    positionsData = data.positions;
                    updateSummary(data);
                    renderPositions(data.positions);
                    document.getElementById('loadingIndicator').style.display = 'none';
                })
                .catch(error => {
                    console.error('Error loading positions:', error);
                    document.getElementById('loadingIndicator').style.display = 'none';
                });
        }

        function reloadPositions() {
            if (!accountPrefix) {
                alert('Please select an account first.');
                return;
            }
            document.getElementById('loadingIndicator').style.display = 'block';
            fetch(`/api/account/${accountPrefix}/reload-positions`, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log(data.message);
                        // After reload, fetch fresh positions for display
                        return fetch(`/api/account/${accountPrefix}/positions`)
                            .then(r => r.json())
                            .then(fresh => {
                                positionsData = fresh.positions;
                                updateSummary(fresh);
                                renderPositions(fresh.positions);
                            });
                    } else {
                        alert('Reload failed: ' + (data.error || 'Unknown error'));
                    }
                })
                .catch(err => {
                    console.error('Reload error:', err);
                    alert('Error reloading positions');
                })
                .finally(() => {
                    document.getElementById('loadingIndicator').style.display = 'none';
                });
        }

        function updateSummary(data) {
            const totalPnL = document.getElementById('totalPnL');
            const totalValue = data.total_pnl || 0;
            
            totalPnL.textContent = '$' + totalValue.toFixed(2);
            totalPnL.className = totalValue > 0 ? 'pnl-positive' : totalValue < 0 ? 'pnl-negative' : 'pnl-neutral';
            
            document.getElementById('lastUpdate').textContent = data.last_update;
            
            const marketStatus = document.getElementById('marketStatus');
            if (data.market_open) {
                marketStatus.textContent = 'Market Open';
                marketStatus.className = 'badge bg-success ms-2';
            } else {
                marketStatus.textContent = 'Market Closed';
                marketStatus.className = 'badge bg-secondary ms-2';
            }
            
            const tradingMode = document.getElementById('tradingMode');
            if (data.live_trading_mode) {
                tradingMode.textContent = 'üî• LIVE TRADING';
                tradingMode.className = 'badge bg-danger ms-2';
            } else {
                tradingMode.textContent = 'READ-ONLY';
                tradingMode.className = 'badge bg-warning ms-2';
            }
        }

        function renderPositions(positions) {
            const container = document.getElementById('positionsContainer');
            
            if (positions.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-info">
                        <h5>No Positions</h5>
                        <p>No long option positions found to monitor.</p>
                    </div>
                `;
                return;
            }

            let html = '';
            
            positions.forEach((pos, index) => {
                const statusIcon = pos.pnl > 0 ? 'status-green' : pos.pnl < 0 ? 'status-red' : 'status-gray';
                const pnlClass = pos.pnl > 0 ? 'pnl-positive' : pos.pnl < 0 ? 'pnl-negative' : 'pnl-neutral';
                
                // Trailing stop indicator
                let trailStopIndicator = '';
                if (pos.trail_stop.order_submitted) {
                    trailStopIndicator = `<span class="trail-stop-indicator trail-stop-submitted">‚ö° ORDER SUBMITTED</span>`;
                } else if (pos.trail_stop.enabled) {
                    const trailClass = pos.trail_stop.triggered ? 'trail-stop-triggered' : 'trail-stop-active';
                    const trailText = pos.trail_stop.triggered ? 'üî• TRIGGERED!' : `üìà ${pos.trail_stop.percent}%`;
                    trailStopIndicator = `<span class="trail-stop-indicator ${trailClass}">${trailText}</span>`;
                }
                
                // Take profit indicator  
                let takeProfitIndicator = '';
                if (pos.take_profit && pos.take_profit.enabled) {
                    const takeProfitClass = pos.take_profit.triggered ? 'take-profit-triggered' : 'take-profit-active';
                    const takeProfitText = pos.take_profit.triggered ? 'üí∞ TRIGGERED!' : `${pos.take_profit.percent}%`;
                    takeProfitIndicator = `<span class="take-profit-indicator ${takeProfitClass}">${takeProfitText}</span>`;
                }
                
                html += `
                    <div class="card position-card">
                        <div class="card-header">
                            <div class="row align-items-center">
                                <div class="col">
                                    <h5 class="mb-0">
                                        <span class="status-indicator ${statusIcon}"></span>
                                        ${pos.symbol} ${pos.strike_price}${pos.option_type} ${pos.expiration_date}
                                        ${trailStopIndicator}
                                        ${takeProfitIndicator}
                                    </h5>
                                </div>
                                <div class="col-auto">
                                    <button class="btn btn-outline-info btn-sm me-2" ${pos.trail_stop.order_submitted ? 'disabled' : ''} onclick="showTrailStopModal('${pos.symbol}', ${index})">
                                        Trail Stop
                                    </button>
                                    <button class="btn btn-outline-success btn-sm me-2" onclick="showTakeProfitModal('${pos.symbol}', ${index})">
                                        üí∞ Take Profit
                                    </button>
                                    <button class="btn btn-outline-warning btn-sm" ${pos.trail_stop.order_submitted ? 'disabled title="Order already submitted via trailing stop"' : ''} onclick="showCloseModal([${index}])">
                                        üì§ Close Position
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <table class="table table-sm">
                                        <tr>
                                            <td>Quantity:</td>
                                            <td><strong>${pos.quantity}</strong></td>
                                        </tr>
                                        <tr>
                                            <td>Premium Paid:</td>
                                            <td>$${pos.open_premium.toFixed(2)}</td>
                                        </tr>
                                        <tr>
                                            <td>Current Mark:</td>
                                            <td>$${pos.current_price.toFixed(2)}</td>
                                        </tr>
                                        <tr>
                                            <td>P&L:</td>
                                            <td class="${pnlClass}"><strong>$${pos.pnl.toFixed(2)} (${pos.pnl_percent.toFixed(1)}%)</strong></td>
                                        </tr>
                                        ${pos.trail_stop.enabled ? `
                                        <tr>
                                            <td>Trail Stop:</td>
                                            <td>
                                                <small>High: $${pos.trail_stop.highest_price.toFixed(2)}<br>
                                                Trigger: $${pos.trail_stop.trigger_price.toFixed(2)}</small>
                                            </td>
                                        </tr>
                                        ` : ''}
                                    </table>
                                </div>
                                <div class="col-md-6">
                                    <h6>Close Order Preview:</h6>
                                    <div class="order-code">robin_stocks.order_sell_option_limit(
    positionEffect='${pos.close_order.positionEffect}',
    creditOrDebit='${pos.close_order.creditOrDebit}',
    price=${pos.close_order.price},
    symbol='${pos.close_order.symbol}',
    quantity=${pos.close_order.quantity},
    expirationDate='${pos.close_order.expirationDate}',
    strike=${pos.close_order.strike},
    optionType='${pos.close_order.optionType}',
    timeInForce='${pos.close_order.timeInForce}'
)</div>
                                    <small class="text-muted mt-2 d-block">
                                        Estimated proceeds: <strong>$${pos.close_order.estimated_proceeds.toFixed(2)}</strong>
                                        ${pos.trail_stop.enabled ? `<br><span class="text-info">Trail Stop: ${pos.trail_stop.percent}% (Trigger: $${pos.trail_stop.trigger_price.toFixed(2)})</span>` : ''}
                                        ${pos.trail_stop.triggered ? `<br><span class="text-danger"><strong>‚ö†Ô∏è TRAILING STOP TRIGGERED!</strong></span>` : ''}
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            // Add close all button
            if (positions.length > 1) {
                html += `
                    <div class="text-center mb-4">
                        <button class="btn btn-warning btn-lg" onclick="showCloseModal('all')">
                            Close ALL Positions (${positions.length})
                        </button>
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        function showCloseModal(positionIndices) {
            const modal = new bootstrap.Modal(document.getElementById('closeModal'));
            const ordersList = document.getElementById('closeOrdersList');
            const totalProceeds = document.getElementById('totalProceeds');
            
            let positions = [];
            let total = 0;
            
            if (positionIndices === 'all') {
                positions = positionsData;
                selectedPositions = positions.map((_, i) => i);
            } else {
                positions = positionIndices.map(i => positionsData[i]);
                selectedPositions = positionIndices;
            }
            
            let html = '';
            positions.forEach((pos, i) => {
                total += pos.close_order.estimated_proceeds;
                // Add trailing stop info if enabled
                let trailStopInfo = '';
                if (pos.trail_stop.enabled) {
                    const statusClass = pos.trail_stop.triggered ? 'text-danger' : 'text-info';
                    const statusText = pos.trail_stop.triggered ? 'üî• TRIGGERED!' : `üéØ ${pos.trail_stop.percent}% Trail`;
                    trailStopInfo = `<br><span class="${statusClass}"><small>${statusText} (Trigger: $${pos.trail_stop.trigger_price.toFixed(2)})</small></span>`;
                }
                
                html += `
                    <div class="mb-3 p-2 border rounded">
                        <strong>${pos.symbol} ${pos.strike_price}${pos.option_type}</strong><br>
                        <small>Limit: $${pos.close_order.price} ‚Üí Proceeds: $${pos.close_order.estimated_proceeds.toFixed(2)}</small>
                        ${trailStopInfo}
                    </div>
                `;
            });
            
            ordersList.innerHTML = html;
            totalProceeds.textContent = '$' + total.toFixed(2);
            
            // Initialize calculated orders with default close_order data
            window.calculatedOrders = positions.map(pos => ({
                price: pos.close_order.price,
                estimated_proceeds: pos.close_order.estimated_proceeds,
                ...pos.close_order
            }));
            
            modal.show();
            
            // Show default prices with editable inputs
            resetToDefault();
        }
        
        function updateStopLossButton() {
            const percent = document.getElementById('stopLossSlider').value;
            document.getElementById('stopLossPercentDisplay').textContent = percent;
        }
        
        function updateStopLossPrice() {
            updateStopLossButton();
            calculateStopLoss();
        }
        
        function updateTakeProfitButton() {
            const percent = document.getElementById('takeProfitSlider').value;
            document.getElementById('takeProfitPercentDisplay').textContent = percent;
        }
        
        function updateTakeProfitPrice() {
            updateTakeProfitButton();
            calculateTakeProfit();
        }
        
        function calculateStopLoss() {
            // Get current slider value
            const percent = parseFloat(document.getElementById('stopLossSlider').value);
            updateOrdersList(positions => positions.map(pos => {
                const stopPrice = pos.current_price * (1 - percent / 100);
                return {
                    ...pos.close_order,
                    price: stopPrice,
                    estimated_proceeds: stopPrice * pos.quantity * 100
                };
            }));
        }
        
        function calculateTakeProfit() {
            // Get current slider value
            const percent = parseFloat(document.getElementById('takeProfitSlider').value);
            updateOrdersList(positions => positions.map(pos => {
                const targetValue = pos.open_premium * (1 + percent / 100);
                const limitPrice = targetValue / (pos.quantity * 100);
                return {
                    ...pos.close_order,
                    price: limitPrice,
                    estimated_proceeds: targetValue
                };
            }));
        }
        
        function resetToDefault() {
            // Reset to original default prices
            updateOrdersList(positions => positions.map(pos => pos.close_order));
        }
        
        function updateOrdersList(priceCalculator) {
            const ordersList = document.getElementById('closeOrdersList');
            const totalProceeds = document.getElementById('totalProceeds');
            
            let positions = selectedPositions.map(i => positionsData[i]);
            let calculatedOrders = priceCalculator(positions);
            let total = 0;
            let html = '';
            
            positions.forEach((pos, i) => {
                const order = calculatedOrders[i];
                total += order.estimated_proceeds;
                
                html += `
                    <div class="mb-3 p-2 border rounded">
                        <strong>${pos.symbol} ${pos.strike_price}${pos.option_type}</strong><br>
                        <div class="row align-items-center">
                            <div class="col-auto">
                                <label class="form-label mb-0">Limit Price:</label>
                            </div>
                            <div class="col">
                                <input type="number" class="form-control form-control-sm" 
                                       value="${order.price}" step="0.01" min="0" 
                                       onchange="updateSingleOrder(${i}, this.value)">
                            </div>
                            <div class="col-auto">
                                <small>‚Üí $${order.estimated_proceeds.toFixed(2)}</small>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            ordersList.innerHTML = html;
            totalProceeds.textContent = '$' + total.toFixed(2);
            
            // Store calculated orders for later use
            window.calculatedOrders = calculatedOrders;
        }
        
        function updateSingleOrder(positionIndex, newPrice) {
            const pos = positionsData[selectedPositions[positionIndex]];
            const newProceeds = parseFloat(newPrice) * pos.quantity * 100;
            
            // Update the stored order
            window.calculatedOrders[positionIndex].price = parseFloat(newPrice);
            window.calculatedOrders[positionIndex].estimated_proceeds = newProceeds;
            
            // Update display
            const orderDiv = document.querySelectorAll('#closeOrdersList .border')[positionIndex];
            const proceedsSpan = orderDiv.querySelector('small');
            proceedsSpan.textContent = `‚Üí $${newProceeds.toFixed(2)}`;
            
            // Update total
            const total = window.calculatedOrders.reduce((sum, order) => sum + order.estimated_proceeds, 0);
            document.getElementById('totalProceeds').textContent = '$' + total.toFixed(2);
        }

function executeCloseOrders() {
    const submitButton = document.getElementById('submitOrdersBtn');
    const originalText = submitButton.innerHTML;
            
            submitButton.innerHTML = '‚è≥ Processing...';
            submitButton.disabled = true;
            
            // Get the positions with updated prices from the dialog
            let ordersToSubmit = selectedPositions.map((positionIndex, i) => {
                const originalPosition = positionsData[positionIndex];
                
                // Use calculated order price if available, otherwise use original
                if (window.calculatedOrders && window.calculatedOrders[i]) {
                    return {
                        ...originalPosition,
                        close_order: {
                            ...originalPosition.close_order,
                            price: window.calculatedOrders[i].price,
                            estimated_proceeds: window.calculatedOrders[i].estimated_proceeds
                        }
                    };
                }
                return originalPosition;
            });
            
            fetch(accountPrefix ? `/api/account/${accountPrefix}/close-simulation` : '/api/close-simulation', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({positions: ordersToSubmit})
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('‚úÖ ' + data.message);
                    // Start monitoring order status for live orders
                    if (data.orders && data.orders.length > 0) {
                        startOrderStatusMonitoring(data.orders);
                    }
                } else if (data.error) {
                    alert('‚ùå ' + data.error);
                }
                
                submitButton.innerHTML = originalText;
                submitButton.disabled = false;
                bootstrap.Modal.getInstance(document.getElementById('closeModal')).hide();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error processing orders');
                submitButton.innerHTML = originalText;
                submitButton.disabled = false;
            });
        }
        
        
        function startOrderStatusMonitoring(orders) {
            // Poll every 2 seconds for the first 15 seconds to catch fills
            let pollCount = 0;
            const maxPolls = 8; // 15 seconds total
            
            const pollInterval = setInterval(() => {
                pollCount++;
                
                fetch(accountPrefix ? `/api/account/${accountPrefix}/check-orders` : '/api/check-orders')
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.orders) {
                            // Update the orders table in real-time
                            renderOrdersTable(data);
                            
                            const filledOrders = data.orders.filter(order => 
                                ['filled', 'partially_filled'].includes(order.state)
                            );
                            
                            // Silent fill detection - just update the table
                            if (filledOrders.length > 0) {
                                console.log(`üìà ${filledOrders.length} order(s) filled`);
                            }
                        }
                        
                        // Stop polling after max attempts or if all orders are filled
                        if (pollCount >= maxPolls) {
                            clearInterval(pollInterval);
                        }
                    })
                    .catch(error => {
                        console.error('Polling error:', error);
                        clearInterval(pollInterval);
                    });
            }, 2000);
        }

        let currentTrailStopSymbol = '';
        let currentTrailStopPosition = null;

        function showTrailStopModal(symbol, positionIndex) {
            const modal = new bootstrap.Modal(document.getElementById('trailStopModal'));
            currentTrailStopSymbol = symbol;
            currentTrailStopPosition = positionsData[positionIndex];
            
            // Update modal content
            document.getElementById('trailStopSymbol').textContent = 
                `Position: ${currentTrailStopPosition.symbol} ${currentTrailStopPosition.strike_price}${currentTrailStopPosition.option_type}`;
            document.getElementById('trailStopCurrentPrice').textContent = currentTrailStopPosition.current_price.toFixed(2);
            
            // Set current configuration
            document.getElementById('trailStopEnabled').checked = currentTrailStopPosition.trail_stop.enabled;
            document.getElementById('trailStopPercent').value = currentTrailStopPosition.trail_stop.percent;
            
            updateTrailStopPreview();
            modal.show();
        }

        function updateTrailStopPreview() {
            const percent = parseFloat(document.getElementById('trailStopPercent').value);
            const currentPrice = currentTrailStopPosition.current_price;
            const triggerPrice = currentPrice * (1 - percent / 100);
            
            document.getElementById('trailStopPercentDisplay').textContent = percent;
            document.getElementById('trailStopPercentInfo').textContent = percent;
            document.getElementById('trailStopTriggerPreview').textContent = triggerPrice.toFixed(2);
        }

        function saveTrailStopConfig() {
            const enabled = document.getElementById('trailStopEnabled').checked;
            const percent = parseFloat(document.getElementById('trailStopPercent').value);
            
            fetch(accountPrefix ? `/api/account/${accountPrefix}/trailing-stop` : '/api/trailing-stop', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    symbol: currentTrailStopSymbol,
                    enabled: enabled,
                    percent: percent
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('‚úÖ ' + data.message);
                    loadPositions(); // Refresh data
                    loadOrders(); // Refresh orders table to show new trailing stop order
                } else {
                    alert('‚ùå Error: ' + data.error);
                }
                bootstrap.Modal.getInstance(document.getElementById('trailStopModal')).hide();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error saving configuration');
            });
        }

        // Take Profit Modal Functions
        let currentTakeProfitSymbol = '';
        let currentTakeProfitPosition = null;

        function showTakeProfitModal(symbol, positionIndex) {
            const modal = new bootstrap.Modal(document.getElementById('takeProfitModal'));
            currentTakeProfitSymbol = symbol;
            currentTakeProfitPosition = positionsData[positionIndex];
            
            // Update modal content
            document.getElementById('takeProfitSymbol').textContent = 
                `Position: ${currentTakeProfitPosition.symbol} ${currentTakeProfitPosition.strike_price}${currentTakeProfitPosition.option_type}`;
            document.getElementById('takeProfitCurrentPnL').textContent = 
                `${currentTakeProfitPosition.pnl_percent >= 0 ? '+' : ''}${currentTakeProfitPosition.pnl_percent.toFixed(1)}%`;
            
            // Set current configuration (default to 50% if not set)
            document.getElementById('takeProfitEnabled').checked = currentTakeProfitPosition.take_profit?.enabled || false;
            document.getElementById('takeProfitPercent').value = currentTakeProfitPosition.take_profit?.percent || 50;
            
            updateTakeProfitPreview();
            modal.show();
        }

        function updateTakeProfitPreview() {
            const percent = parseFloat(document.getElementById('takeProfitPercent').value);
            const openPremium = currentTakeProfitPosition.open_premium;
            const targetValue = openPremium * (1 + percent / 100);
            const targetProfit = targetValue - openPremium;
            
            document.getElementById('takeProfitPercentDisplay').textContent = percent;
            document.getElementById('takeProfitPercentInfo').textContent = percent;
            document.getElementById('takeProfitTargetDisplay').textContent = targetProfit.toFixed(2);
        }

        function saveTakeProfitConfig() {
            const enabled = document.getElementById('takeProfitEnabled').checked;
            const percent = parseFloat(document.getElementById('takeProfitPercent').value);
            
            fetch(accountPrefix ? `/api/account/${accountPrefix}/take-profit` : '/api/take-profit', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    symbol: currentTakeProfitSymbol,
                    enabled: enabled,
                    percent: percent
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`‚úÖ Take profit configuration saved for ${currentTakeProfitSymbol}`);
                    loadPositions(); // Refresh data
                } else {
                    alert('‚ùå Error: ' + data.error);
                }
                bootstrap.Modal.getInstance(document.getElementById('takeProfitModal')).hide();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error saving configuration');
            });
        }

        // Update preview when slider changes
        document.getElementById('takeProfitPercent').addEventListener('input', updateTakeProfitPreview);

        function checkOrderStatus() {
            fetch(accountPrefix ? `/api/account/${accountPrefix}/check-orders` : '/api/check-orders')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        if (data.orders && data.orders.length > 0) {
                            let message = `üìã Found ${data.orders.length} order(s)\n`;
                            message += `Mode: ${data.live_trading_mode ? 'üî• LIVE TRADING' : 'üõà READ-ONLY'}\n\n`;
                            
                            data.orders.forEach((order, i) => {
                                const symbol = order.symbol || 'Unknown';
                                const state = order.state || 'Unknown';
                                const price = order.price || order.limit_price || 'Unknown';
                                
                                message += `${i+1}. ${symbol}: ${state.toUpperCase()}\n`;
                                message += `   Price: $${price}\n`;
                                message += `   Order ID: ${order.id || 'Unknown'}\n`;
                                message += `\n`;
                            });
                            
                            alert(message);
                            console.log('Orders Details:', data.orders);
                        } else {
                            const modeText = data.live_trading_mode ? 'real' : 'read-only';
                            alert(`‚úÖ No ${modeText} orders found`);
                        }
                    } else {
                        alert('‚ùå Error checking orders: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error checking order status');
                });
        }

        function cancelOrder(orderId) {
            // Confirm cancellation
            if (!confirm(`Are you sure you want to cancel order ${orderId}?`)) {
                return;
            }
            
            // Disable the cancel button to prevent double-clicks
            const buttons = document.querySelectorAll(`[onclick="cancelOrder('${orderId}')"]`);
            buttons.forEach(btn => {
                btn.innerHTML = '‚è≥ Cancelling...';
                btn.disabled = true;
            });
            
            fetch(`/api/cancel-order/${orderId}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('‚úÖ Order cancelled:', data.message);
                    // Refresh the orders table to show updated status
                    loadOrders();
                } else {
                    alert('‚ùå Cancel failed: ' + data.error);
                    // Re-enable the button if cancellation failed
                    buttons.forEach(btn => {
                        btn.innerHTML = '‚ùå Cancel';
                        btn.disabled = false;
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error cancelling order');
                // Re-enable the button on error
                buttons.forEach(btn => {
                    btn.innerHTML = '‚ùå Cancel';
                    btn.disabled = false;
                });
            });
        }

        // Update preview when slider changes
        document.getElementById('trailStopPercent').addEventListener('input', updateTrailStopPreview);

        function refreshTrackedOrders() {
            fetch(accountPrefix ? `/api/account/${accountPrefix}/refresh-tracked-orders` : '/api/refresh-tracked-orders')
                .then(response => response.json())
                .then(data => {
                    renderOrdersTable(data);
                })
                .catch(error => {
                    console.error('Error refreshing tracked orders:', error);
                });
        }

        function loadOrders() {
            fetch(accountPrefix ? `/api/account/${accountPrefix}/check-orders` : '/api/check-orders')
                .then(response => response.json())
                .then(data => {
                    renderOrdersTable(data);
                })
                .catch(error => {
                    console.error('Error loading orders:', error);
                });
        }

        function renderOrdersTable(data) {
            const ordersSection = document.getElementById('ordersSection');
            const ordersTableBody = document.getElementById('ordersTableBody');
            const orderCount = document.getElementById('orderCount');
            const orderMode = document.getElementById('orderMode');
            
            // Always show the table section to make it visible
            ordersSection.style.display = 'block';
            
            // Update mode badge regardless of orders
            if (data.live_trading_mode) {
                orderMode.textContent = 'üî• LIVE TRADING';
                orderMode.className = 'badge bg-danger ms-2';
            } else {
                orderMode.textContent = 'üõà READ-ONLY';
                orderMode.className = 'badge bg-secondary ms-2';
            }
            
            if (!data.success || !data.orders || data.orders.length === 0) {
                orderCount.textContent = '0';
                ordersTableBody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No orders found</td></tr>';
                return;
            }
            
            // Update header info
            orderCount.textContent = data.orders.length;
            
            // Render table rows
            let html = '';
            data.orders.forEach(order => {
                const orderId = order.id || 'Unknown';
                const displayId = data.live_trading_mode ? 
                    orderId.substring(0, 8) + '...' : 
                    orderId;
                
                const symbol = order.symbol || 'Unknown';
                const quantity = order.quantity || 'Unknown';
                const price = order.price || order.limit_price || 'Unknown';
                const state = order.state || 'Unknown';
                
                // Format timestamp
                let submittedTime = 'Unknown';
                if (order.submit_time) {
                    // Handle both Unix timestamp and date string
                    const timestamp = typeof order.submit_time === 'number' ? order.submit_time * 1000 : order.submit_time;
                    submittedTime = new Date(timestamp).toLocaleTimeString();
                } else if (order.created_at) {
                    submittedTime = new Date(order.created_at).toLocaleTimeString();
                } else if (order.timestamp) {
                    submittedTime = new Date(order.timestamp).toLocaleTimeString();
                }
                
                const stateClass = `order-state-${state.toLowerCase().replace(' ', '_')}`;
                
                // Determine order type based on order details
                let orderType = 'Limit';
                
                // Check order type from backend data
                if (order.order_type === 'stop_limit') {
                    orderType = '<span class="text-info">Stop-Limit</span>';
                } else if (order.api_call && order.api_call.includes('trailing stop')) {
                    // Fallback check for API call content
                    orderType = '<span class="text-info">Stop-Limit</span>';
                } else {
                    orderType = 'Limit';
                }
                
                // Add cancel button for confirmed orders only
                let actionsCell = '';
                if (state.toLowerCase() === 'confirmed') {
                    actionsCell = `<button class="btn btn-outline-danger btn-sm" onclick="cancelOrder('${orderId}')">‚ùå Cancel</button>`;
                } else {
                    actionsCell = '<span class="text-muted">-</span>';
                }
                
                html += `
                    <tr>
                        <td class="order-id">${displayId}</td>
                        <td><strong>${symbol}</strong></td>
                        <td>${orderType}</td>
                        <td>${quantity}</td>
                        <td>$${price}</td>
                        <td><span class="badge ${stateClass}">${state.toUpperCase()}</span></td>
                        <td><small class="text-muted">${submittedTime}</small></td>
                        <td>${actionsCell}</td>
                    </tr>
                `;
            });
            
            ordersTableBody.innerHTML = html;
        }

        // Auto-refresh every 10 seconds
        setInterval(() => {
            loadPositions();
            refreshTrackedOrders(); // Auto-refresh only tracked orders
        }, 10000);
        
        // Initial load
        loadPositions();
    </script>
</body>
</html>
